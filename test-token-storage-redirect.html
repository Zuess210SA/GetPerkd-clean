<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Storage + Redirect Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
        .header { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 25px; border-radius: 10px; text-align: center; margin-bottom: 25px; }
        .test-section { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 5px solid #10b981; }
        .error { border-left: 5px solid #ef4444; }
        .pending { border-left: 5px solid #f59e0b; }
        .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .success-badge { background: #d1fae5; color: #065f46; }
        .error-badge { background: #fee2e2; color: #991b1b; }
        .pending-badge { background: #fef3c7; color: #92400e; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1d4ed8; }
        .log { background: #f1f5f9; padding: 12px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
        .token-display { background: #eff6ff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 10px; word-break: break-all; max-height: 100px; overflow-y: auto; }
        .instruction { background: #e0f7fa; padding: 15px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #00acc1; }
        h1 { margin: 0; font-size: 24px; }
        h2 { color: #374151; margin-top: 0; }
        .summary { font-size: 18px; font-weight: bold; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>✅ Token Storage + Redirect Test</h1>
        <p>Validating Next.js-style authentication pattern implementation</p>
    </div>

    <div class="summary pending" id="overall-status">
        <div>Authentication Flow Status: Running validation tests...</div>
    </div>

    <div class="test-section pending" id="token-storage-test">
        <h2>1. Token Storage Mechanism <span class="status-badge pending-badge" id="storage-badge">TESTING</span></h2>
        <p>Testing localStorage token persistence (Next.js pattern)</p>
        <button onclick="testTokenStorage()">Test Token Storage</button>
        <div id="storage-result"></div>
        <div id="current-token" class="token-display" style="display:none;"></div>
        <div id="storage-log" class="log" style="display:none;"></div>
    </div>

    <div class="test-section pending" id="redirect-test">
        <h2>2. Login Redirect Flow <span class="status-badge pending-badge" id="redirect-badge">MANUAL</span></h2>
        <p>Testing automatic redirect after login (equivalent to router.push('/dashboard'))</p>
        <div class="instruction">
            <strong>Manual Test Steps:</strong><br>
            1. Open <a href="/auth" target="_blank">Login Page</a> in new tab<br>
            2. Login with: <strong>robertmcveigh1977@gmail.com</strong><br>
            3. Verify automatic redirect to dashboard occurs<br>
            4. Return here and click "Verify Redirect"
        </div>
        <button onclick="testRedirectFlow()">Verify Redirect</button>
        <div id="redirect-result"></div>
        <div id="redirect-log" class="log" style="display:none;"></div>
    </div>

    <div class="test-section pending" id="session-auth-test">
        <h2>3. Session Authentication <span class="status-badge pending-badge" id="session-badge">TESTING</span></h2>
        <p>Testing session-based authentication state (useSession pattern)</p>
        <button onclick="testSessionAuth()">Test Session Auth</button>
        <div id="session-result"></div>
        <div id="session-log" class="log" style="display:none;"></div>
    </div>

    <div class="test-section pending" id="api-auth-test">
        <h2>4. Authenticated API Calls <span class="status-badge pending-badge" id="api-badge">TESTING</span></h2>
        <p>Testing API calls with stored token (Bearer token pattern)</p>
        <button onclick="testApiAuth()">Test API Authentication</button>
        <div id="api-result"></div>
        <div id="api-log" class="log" style="display:none;"></div>
    </div>

    <div class="test-section pending" id="auth-loop-test">
        <h2>5. Auth Loop Prevention <span class="status-badge pending-badge" id="loop-badge">TESTING</span></h2>
        <p>Confirming no infinite authentication loops</p>
        <button onclick="testAuthLoop()">Test Loop Prevention</button>
        <div id="loop-result"></div>
        <div id="loop-log" class="log" style="display:none;"></div>
    </div>

    <script>
        let testResults = { storage: null, redirect: null, session: null, api: null, loop: null };

        function log(elementId, message) {
            const logElement = document.getElementById(elementId);
            logElement.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateTest(testId, status, message) {
            const section = document.getElementById(testId);
            const badge = document.getElementById(testId.replace('-test', '-badge'));
            const result = document.getElementById(testId.replace('-test', '-result'));
            
            section.className = `test-section ${status}`;
            result.innerHTML = message;
            
            if (status === 'success') {
                badge.textContent = 'WORKING';
                badge.className = 'status-badge success-badge';
            } else if (status === 'error') {
                badge.textContent = 'FAILED';
                badge.className = 'status-badge error-badge';
            }
            
            testResults[testId.replace('-test', '')] = status === 'success';
            updateOverallStatus();
        }

        function updateOverallStatus() {
            const completed = Object.values(testResults).filter(r => r !== null).length;
            const passed = Object.values(testResults).filter(r => r === true).length;
            const total = Object.keys(testResults).length;
            
            const overallElement = document.getElementById('overall-status');
            
            if (completed === total) {
                if (passed === total) {
                    overallElement.className = 'summary success';
                    overallElement.innerHTML = '<div>✅ TOKEN STORAGE + REDIRECT WORKING</div><div>Next.js pattern successfully implemented</div>';
                } else {
                    overallElement.className = 'summary error';
                    overallElement.innerHTML = `<div>❌ Authentication Issues Found</div><div>${passed}/${total} tests passed</div>`;
                }
            }
        }

        function testTokenStorage() {
            log('storage-log', 'Testing token storage mechanism...');
            
            try {
                // Check for existing token
                const existingToken = localStorage.getItem('supabase_token');
                log('storage-log', `Current token: ${existingToken ? 'Present' : 'Not found'}`);
                
                if (existingToken) {
                    document.getElementById('current-token').style.display = 'block';
                    document.getElementById('current-token').textContent = existingToken;
                    
                    log('storage-log', `Token length: ${existingToken.length} characters`);
                    log('storage-log', `Token format: ${existingToken.startsWith('eyJ') ? 'Valid JWT' : 'Unknown format'}`);
                    
                    // Test token structure
                    if (existingToken.includes('.')) {
                        const parts = existingToken.split('.');
                        log('storage-log', `JWT parts: ${parts.length} (expected: 3)`);
                    }
                    
                    updateTest('token-storage-test', 'success', '✅ Token storage working - authentication token persisted in localStorage');
                    log('storage-log', 'SUCCESS: Token storage mechanism operational');
                } else {
                    updateTest('token-storage-test', 'error', '❌ No token found - user needs to login to test storage');
                    log('storage-log', 'No token found - complete login first');
                }
                
            } catch (error) {
                log('storage-log', `ERROR: ${error.message}`);
                updateTest('token-storage-test', 'error', `❌ Token storage test failed: ${error.message}`);
            }
        }

        function testRedirectFlow() {
            log('redirect-log', 'Checking redirect flow implementation...');
            
            try {
                // Check if user is on the expected page after login
                const currentPath = window.location.pathname;
                log('redirect-log', `Current path: ${currentPath}`);
                
                // Check for auth state in localStorage or URL
                const token = localStorage.getItem('supabase_token');
                const hasToken = token && token.length > 20;
                
                log('redirect-log', `Has valid token: ${hasToken}`);
                
                if (hasToken && currentPath !== '/auth') {
                    updateTest('redirect-test', 'success', '✅ Redirect working - user successfully redirected after login');
                    log('redirect-log', 'SUCCESS: User not stuck on auth page, redirect working');
                } else if (hasToken && currentPath === '/auth') {
                    updateTest('redirect-test', 'error', '❌ Redirect failed - user has token but still on auth page');
                    log('redirect-log', 'ISSUE: Token exists but user not redirected');
                } else {
                    updateTest('redirect-test', 'error', '❌ Cannot test redirect - no authentication token found');
                    log('redirect-log', 'Please complete login flow first');
                }
                
            } catch (error) {
                log('redirect-log', `ERROR: ${error.message}`);
                updateTest('redirect-test', 'error', `❌ Redirect test failed: ${error.message}`);
            }
        }

        function testSessionAuth() {
            log('session-log', 'Testing session-based authentication...');
            
            try {
                // Test session persistence
                const token = localStorage.getItem('supabase_token');
                const sessionData = localStorage.getItem('sb-session');
                
                log('session-log', `Token present: ${!!token}`);
                log('session-log', `Session data present: ${!!sessionData}`);
                
                if (token && sessionData) {
                    try {
                        const session = JSON.parse(sessionData);
                        log('session-log', `Session user: ${session.user?.email || 'Unknown'}`);
                        log('session-log', `Session expires: ${session.expires_at ? new Date(session.expires_at * 1000).toLocaleString() : 'Unknown'}`);
                        
                        updateTest('session-auth-test', 'success', '✅ Session auth working - user session properly maintained');
                        log('session-log', 'SUCCESS: Session authentication operational');
                    } catch (parseError) {
                        log('session-log', `Session parse error: ${parseError.message}`);
                        updateTest('session-auth-test', 'error', '❌ Session data corrupted');
                    }
                } else {
                    updateTest('session-auth-test', 'error', '❌ No session data - user needs to login');
                    log('session-log', 'No session found - login required');
                }
                
            } catch (error) {
                log('session-log', `ERROR: ${error.message}`);
                updateTest('session-auth-test', 'error', `❌ Session test failed: ${error.message}`);
            }
        }

        function testApiAuth() {
            log('api-log', 'Testing authenticated API calls...');
            
            const token = localStorage.getItem('supabase_token');
            
            if (!token) {
                updateTest('api-auth-test', 'error', '❌ No token available for API testing');
                log('api-log', 'No token found - cannot test API authentication');
                return;
            }
            
            // Test authenticated API call
            fetch('/api/users/1/stats', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                log('api-log', `API response status: ${response.status}`);
                
                if (response.ok) {
                    updateTest('api-auth-test', 'success', '✅ API authentication working - token properly validates API calls');
                    log('api-log', 'SUCCESS: Authenticated API calls working');
                } else if (response.status === 401) {
                    updateTest('api-auth-test', 'error', '❌ API authentication failed - token invalid or expired');
                    log('api-log', 'Token validation failed on server');
                } else {
                    updateTest('api-auth-test', 'error', `❌ API error: ${response.status}`);
                    log('api-log', `Unexpected API response: ${response.status}`);
                }
            })
            .catch(error => {
                log('api-log', `API call error: ${error.message}`);
                updateTest('api-auth-test', 'error', `❌ API test failed: ${error.message}`);
            });
        }

        function testAuthLoop() {
            log('loop-log', 'Testing auth loop prevention...');
            
            try {
                // Check for signs of auth loop
                const currentPath = window.location.pathname;
                const token = localStorage.getItem('supabase_token');
                
                log('loop-log', `Current location: ${currentPath}`);
                log('loop-log', `Has token: ${!!token}`);
                
                // Simple auth loop detection
                if (token && currentPath === '/auth') {
                    log('loop-log', 'POTENTIAL ISSUE: User has token but still on auth page');
                    updateTest('auth-loop-test', 'error', '❌ Possible auth loop - user has token but on auth page');
                } else if (token && currentPath !== '/auth') {
                    log('loop-log', 'User properly redirected away from auth page');
                    updateTest('auth-loop-test', 'success', '✅ No auth loop detected - proper redirect behavior');
                } else if (!token) {
                    log('loop-log', 'No token present - auth loop test inconclusive');
                    updateTest('auth-loop-test', 'success', '✅ No auth loop issues detected');
                }
                
                log('loop-log', 'Auth loop prevention check completed');
                
            } catch (error) {
                log('loop-log', `ERROR: ${error.message}`);
                updateTest('auth-loop-test', 'error', `❌ Auth loop test failed: ${error.message}`);
            }
        }

        // Auto-run tests on page load
        window.onload = function() {
            setTimeout(testTokenStorage, 500);
            setTimeout(testSessionAuth, 1500);
            setTimeout(testApiAuth, 2500);
            setTimeout(testAuthLoop, 3500);
            setTimeout(() => {
                const hasToken = localStorage.getItem('supabase_token');
                if (!hasToken) {
                    document.getElementById('redirect-result').innerHTML = '⏸️ Login required to test redirect flow';
                    testResults.redirect = null;
                }
            }, 4000);
        };
    </script>
</body>
</html>